<!DOCTYPE HTML>
<html>
<meta charset="utf-8">

<head>
    <title>歷代漢文大藏經概述 D3 Tree Can Vertical 2Kinds</title>
    <base target="_blank">
    <style>
        input {
            /*position: absolute;*/
            float: left;
            height: 60px;
            border-radius: 50%;
            /*margin: 0 0 0 50vw;*/
        }
        
        #toJson {
            position: absolute;
            /*float: left;*/
        }
        
        h2 {
            text-align: center;
        }
        
        .node circle {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 2px;
        }
        
        .node rect {
            stroke-width: 3px;
        }
        
        .node text {
            /*font: 14px sans-serif;*/
            font-size: 1.1em;
            fill: black;
        }
        
        .node {
            fill: lightblue;
            /*word-wrap:break-word;
        white-space:pre;*/
        }
        
        .rectBody {
            transform: rotate(90deg);
        }
        
        .body {
            /*轉直排語法*/
            -webkit-writing-mode: vertical-rl;
            writing-mode: vertical-rl;
        }
        
        .head {
            /*text-align: center;*/
            /*D3語法*/
            text-anchor: middle;
        }
        
        .link {
            fill: none;
            stroke: #cac;
            stroke-width: 2px;
        }
        
        #txt1 {
            width: 60vw;
            height: 30vh;
        }
        
        #myValue {
            width: 60vw;
            background: #aca;
        }
        
        #myValue2 {
            width: 60vw;
            background: snow;
        }
        
        #myValue3 {
            width: 60vw;
            background: bisque;
        }
        
        .g {
            background: gold;
        }
        
        .t {
            background: tomato;
        }
        
        .r {
            background: red;
        }
        
        .sb {
            background: skyblue;
        }
        
        .ky {
            background: khaki;
        }
        
        .pink {
            background: pink;
        }
        
        .y {
            background: yellow;
        }
        
        .o {
            background: orange;
        }
        
        .yg {
            background: yellowgreen;
        }
        
        .b {
            background: lightblue;
        }
        
        .p {
            background: plum;
        }
        
        .lg {
            background: limegreen;
        }
        
        .lsg {
            background: lightseagreen;
        }
        
        .lc {
            background: lightcyan;
        }
        
        .gy {
            background: greenyellow;
        }
        
        .tan {
            background: tan;
        }
    </style>
    <!-- load the d3.js library -->
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script>
        window.onload = function () {
            function d3Example(myKinds, xyRotate, myH2, myId, myTop, myRight, myBottom, myLeft, myWidth, myHeight, myLevel, myDepth, myRectHeight, myRectWidth) {
                h2.innerHTML = myH2
                var treeData = {
                    "name": "漢文大藏經", "subname": "", "fill": "", "children": [
                        {
                            "name": "國內", "subname": "", "fill": "gold", "children": [
                                {
                                    "name": "唐(含之前)", "subname": "", "fill": "", "children": [
                                        { "name": "敦煌手抄本", "subname": "", "fill": "" },]                                
},
                                {
                                    "name": "宋", "subname": "", "fill": "", "children": [
                                        {                                            
"name": "蜀版", "subname": "", "fill": "cyan", "children": [
                                                { "name": "開寶藏(西元971-983)", "subname": "", "fill": "" },]
                                        },
                                        {
                                            "name": "遼版", "subname": "", "fill": "cyan", "children": [
                                                { "name": "契丹藏(丹本)(約1031-1063)", "subname": "", "fill": "" },]                                        
},
                                        {
                                            "name": "金版", "subname": "", "fill": "cyan", "children": [
                                                { "name": "金藏(趙城本)(約1148-1173)", "subname": "", "fill": "" },]
                                        },
                                        {
                                            "name": "福州版", "subname": "", "fill": "cyan", "children": [
                                                { "name": "崇寧萬壽藏(福州東禪寺本)(1080-1140)", "subname": "", "fill": "" },
                                                { "name": "毗廬藏(福州開元寺本)(1115-1150)", "subname": "", "fill": "" },]
                                        },
                                        {
                                            "name": "湖州版", "subname": "", "fill": "cyan", "children": [
                                                { "name": "思溪圓覺藏(1132-)", "subname": "", "fill": "" },
                                                { "name": "思溪資福藏(1175前後)", "subname": "", "fill": "" },]
                                        },
                                        { "name": "磧砂藏(約1231-1322)", "subname": "", "fill": "" },]
                                },
                                {
                                    "name": "元", "subname": "", "fill": "", "children": [
                                        { "name": "普寧藏(1269-1286)", "subname": "", "fill": "" },
                                        { "name": "弘法藏(1277-1294)", "subname": "", "fill": "" },]
                                },
                                {                                    
"name": "明", "subname": "", "fill": "", "children": [
                                        { "name": "南藏(1372-)", "subname": "", "fill": "" },
                                        { "name": "北藏(1410-1441)", "subname": "", "fill": "" },
                                        { "name": "武林藏(約1522-1566)", "subname": "", "fill": "" },
                                        { "name": "徑山藏(嘉興藏本)(1589-1677)", "subname": "", "fill": "" },]
                                },
                                {
                                    "name": "清", "subname": "", "fill": "", "children": [
                                        { "name": "龍藏(1735-1738)", "subname": "", "fill": "" },
                                        { "name": "頻伽藏(1909-1914)", "subname": "", "fill": "" },
                                        { "name": "百衲藏(1866-)", "subname": "", "fill": "" },]
                                },
                            ]
                        },
                        {
                            "name": "國外", "subname": "", "fill": "gold", "children": [
                                {
                                    "name": "高麗", "subname": "", "fill": "lime", "children": [
                                        { "name": "高麗大藏初雕本(約1011-1082)", "subname": "", "fill": "" },
                                        { "name": "高麗續藏本(1094前後)", "subname": "", "fill": "" },
                                        { "name": "高麗大藏再雕本(1236-1251)", "subname": "", "fill": "" },]
                                },
                                {                                    
"name": "日本", "subname": "", "fill": "pink", "children": [
                                        { "name": "天海藏(寬永寺本)(1637-1648)", "subname": "", "fill": "" },
                                        { "name": "黃蘗藏(鐵眼本)(1669-1681)", "subname": "", "fill": "" },
                                        { "name": "弘教藏(縮刷藏本)(1880-1866)", "subname": "", "fill": "" },
                                        { "name": "卍字藏(1902-1905)", "subname": "", "fill": "" },
                                        { "name": "卍字續藏(1905-0912)", "subname": "", "fill": "" },
                                        { "name": "大正新修大藏經(1922-1932)", "subname": "", "fill": "pink" },
                                        { "name": "昭和再訂縮刷藏(1935-)", "subname": "", "fill": "" },
                                        { "name": "聖語藏(古寫本與版本集合而成約自759-1093)", "subname": "", "fill": "" },
                                        { "name": "宮本(即福州東禪寺與開元寺本合成之全藏)", "subname": "", "fill": "" },
                                    ]                                
},
                            ]
                        },
                    ]
                };

                // Set the dimensions and margins of the diagram
                // 設置圖的尺寸和邊距
                var margin = { top: myTop, right: myRight, bottom: myBottom, left: myLeft },
                    width = myWidth - margin.left - margin.right,
                    height = myHeight - margin.top - margin.bottom;

                // append the svg object to the body of the page
                // appends a 'group' element to 'svg'
                // moves the 'group' element to the top left margin
                var svg = d3.select(myId).append("svg")
                    .attr("width", width + margin.right + margin.left)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", "translate("
                    + margin.left + "," + margin.top + ")");

                var i = 0,
                    duration = 750,
                    root;

                // declares a tree layout and assigns the size
                // 聲明樹形佈局並分配大小
                var treemap = d3.tree().size([height, width]);

                // Assigns parent, children, height, depth
                // 分配父項，子項，高度，深度
                root = d3.hierarchy(treeData, function (d) { return d.children; });
                root.x0 = height / 2;
                root.y0 = 0;

                // Collapse after the second level
                // 在第二級之後折疊
                if (myLevel == 1) {
                    root.children.forEach(collapse);
                }

                update(root);

                // Collapse the node and all it's children
                // 折疊節點及其所有子節點
                function collapse(d) {
                    if (d.children) {
                        d._children = d.children
                        d._children.forEach(collapse)
                        d.children = null
                    }
                }

                function update(source) {

                    // Assigns the x and y position for the nodes
                    // 為節點分配x和y位置
                    var treeData = treemap(root);

                    // Compute the new tree layout.
                    // 計算新的樹佈局。
                    var nodes = treeData.descendants(),
                        links = treeData.descendants().slice(1);

                    // Normalize for fixed-depth.
                    // 歸一化為固定深度。
                    nodes.forEach(function (d) { d.y = d.depth * myDepth });

                    // ****************** Nodes section ***************************

                    // Update the nodes...
                    // 更新節點...
                    var node = svg.selectAll('g.node')
                        .data(nodes, function (d) { return d.id || (d.id = ++i); });

                    // Enter any new modes at the parent's previous position.
                    // 在父級的上一個位置輸入任何新模式。
                    var nodeEnter = node.enter().append('g')
                        .attr('class', 'node')
                        .attr("transform", function (d) {
                            // 直排X軸Y軸對調
                            if (xyRotate != 1) {
                                // 橫排
                                return "translate(" + source.y0 + "," + source.x0 + ")";
                            } else {
                                return "translate(" + source.x0 + "," + source.y0 + ")";
                            }
                        })
                        .on('click', click);

                    // 區分兩種樣式
                    if (myKinds != 1) {
                        // 原始樣式
                        // Add Circle for the nodes
                        nodeEnter.append('circle')
                            .attr('class', 'node')
                            .attr('r', 1e-6)
                            .style("fill", function (d) {
                                return d._children ? "lightsteelblue" : "#fff";
                            });

                        // Add labels for the nodes
                        // 為節點添加標籤
                        if (xyRotate != 1) {
                            // 橫排
                            nodeEnter.append('text')
                                .attr("dy", ".35em")
                                .attr("x", function (d) {
                                    // 文字向左向右
                                    return d.children || d._children ? -13 : 13;
                                    // return 13
                                })
                                .attr("text-anchor", function (d) {
                                    return d.children || d._children ? "end" : "start";
                                    // return "start";
                                })
                                .text(function (d) { return d.data.name; });
                        } else {
                            nodeEnter.append('text')
                                .attr("dy", ".35em")
                                // 直排X軸Y軸對調
                                .attr("y", function (d) {
                                    // 文字向左向右
                                    return d.children || d._children ? -20 : 8;
                                })
                                .attr('class', function (d) {
                                    // 區分子節點直排，父節點不直排
                                    return d.children || d._children ? "head" : "body"
                                })
                                .text(function (d) { return d.data.name; });
                        }

                        // add number of children to node circle
                        //  將節點數添加到節點圈
                        nodeEnter.append('text')
                            .attr('x', -4)
                            .attr('y', 4)
                            .attr('cursor', 'pointer')
                            .style('font-size', '12px')
                            .text(function (d) {
                                if (d.children) return d.children.length;
                                else if (d._children) return d._children.length;
                            });

                    } else {
                        // 顏色樣式
                        var rectHeight = myRectHeight, rectWidth = myRectWidth;

                        if (xyRotate != 1) {
                            // 橫排
                            nodeEnter.append('rect')
                                .attr('class', 'node')
                                .attr("width", rectWidth)
                                .attr("height", rectHeight)
                                .attr("x", 0)
                                .attr("y", (rectHeight / 2) * -1)
                                .attr("rx", "5")
                                .style("fill", function (d) {
                                    return d.data.fill;
                                });

                            // Add labels for the nodes
                            // 為節點添加標籤
                            nodeEnter.append('text')
                                .attr("dy", ".35em")
                                // 雙行小名
                                // .attr("dy", "-.35em")
                                .attr("x", function (d) {
                                    return 13;
                                })
                                .attr("text-anchor", function (d) {
                                    return "start";
                                })
                                .text(function (d) { return d.data.name; })
                            // 雙行小名
                            // .append("tspan")
                            // .attr("dy", "1.75em")
                            // .attr("x", function (d) {
                            //    return 13;
                            // })
                            // .text(function (d) { return d.data.subname; });

                        } else {
                            nodeEnter.append('rect')
                                // .attr('class', 'node')
                                .attr('class', function (d) {
                                    // 區分子節點直排，父節點不直排
                                    return d.children || d._children ? "rectHead" : "rectBody"
                                })
                                .attr("width", rectWidth)
                                .attr("height", rectHeight)
                                .attr("x", function (d) {
                                    // 區分子節點直排，父節點不直排
                                    return d.children || d._children ? (rectWidth / 2) * -1 : 0
                                })
                                .attr("y", function (d) {
                                    // 區分子節點直排，父節點不直排
                                    return d.children || d._children ? (rectHeight - 4) * -1 : (rectHeight / 2) * -1
                                })
                                .attr("rx", "5")
                                .style("fill", function (d) {
                                    return d.data.fill;
                                });

                            // Add labels for the nodes
                            // 為節點添加標籤
                            nodeEnter.append('text')
                                .attr("dy", ".35em")
                                // 直排X軸Y軸對調
                                .attr("y", function (d) {
                                    // 文字向左向右
                                    return d.children || d._children ? -8 : 8;
                                })
                                .attr('class', function (d) {
                                    // 區分子節點直排，父節點不直排
                                    return d.children || d._children ? "head" : "body"
                                })
                                // // 雙行小名
                                // // .attr("dy", "-.35em")
                                // .attr("x", function (d) {
                                //     return 13;
                                // })
                                // .attr("text-anchor", function (d) {
                                //     return "start";
                                // })
                                .text(function (d) { return d.data.name; })
                            // 雙行小名
                            // .append("tspan")
                            // .attr("dy", "1.75em")
                            // .attr("x", function (d) {
                            //    return 13;
                            // })
                            // .text(function (d) { return d.data.subname; });
                        }
                    }

                    // UPDATE
                    var nodeUpdate = nodeEnter.merge(node);

                    // Transition to the proper position for the node
                    // 過渡到節點的正確位置
                    nodeUpdate.transition()
                        .duration(duration)
                        .attr("transform", function (d) {
                            // 直排X軸Y軸對調
                            if (xyRotate != 1) {
                                // 橫排
                                return "translate(" + d.y + "," + d.x + ")";
                            } else {
                                return "translate(" + d.x + "," + d.y + ")";
                            }
                        });

                    // Update the node attributes and style
                    // 更新節點屬性和样式
                    nodeUpdate.select('circle.node')
                        .attr('r', 10)
                        .style("fill", function (d) {
                            return d._children ? "red" : "yellow";
                        })
                        .attr('cursor', 'pointer');


                    // Remove any exiting nodes
                    // 刪除所有現有節點
                    var nodeExit = node.exit().transition()
                        .duration(duration)
                        .attr("transform", function (d) {
                            // 直排X軸Y軸對調
                            if (xyRotate != 1) {
                                // 橫排
                                return "translate(" + source.y + "," + source.x + ")";
                            } else {
                                return "translate(" + source.x + "," + source.y + ")";
                            }
                        })
                        .remove();

                    // On exit reduce the node circles size to 0
                    // 在退出時，將節點圓圈的大小減小為0
                    nodeExit.select('circle')
                        .attr('r', 1e-6);

                    // On exit reduce the opacity of text labels
                    // 在退出時減少文本標籤的不透明度
                    nodeExit.select('text')
                        .style('fill-opacity', 1e-6);

                    // ****************** links section ***************************

                    // Update the links...
                    var link = svg.selectAll('path.link')
                        .data(links, function (d) { return d.id; });

                    // Enter any new links at the parent's previous position.
                    // 在父級的上一個位置輸入任何新鏈接。
                    var linkEnter = link.enter().insert('path', "g")
                        .attr("class", "link")
                        .attr('d', function (d) {
                            var o = { x: source.x0, y: source.y0 }
                            return diagonal(o, o)
                        });

                    // UPDATE
                    var linkUpdate = linkEnter.merge(link);

                    // Transition back to the parent element position
                    // 過渡回父元素位置
                    linkUpdate.transition()
                        .duration(duration)
                        .attr('d', function (d) { return diagonal(d, d.parent) });

                    // Remove any exiting links
                    // 刪除所有現有鏈接
                    var linkExit = link.exit().transition()
                        .duration(duration)
                        .attr('d', function (d) {
                            var o = { x: source.x, y: source.y }
                            return diagonal(o, o)
                        })
                        .remove();

                    // Store the old positions for transition.
                    // 存儲舊職位以進行過渡。
                    nodes.forEach(function (d) {
                        d.x0 = d.x;
                        d.y0 = d.y;
                    });

                    // Creates a curved (diagonal) path from parent to the child nodes
                    // 創建從父節點到子節點的彎曲（對角線）路徑
                    function diagonal(s, d) {
                        // 直排X軸Y軸對調
                        if (xyRotate != 1) {
                            // 橫排
                            path = `M ${s.y} ${s.x}
                        C ${(s.y + d.y) / 2} ${s.x},
                          ${(s.y + d.y) / 2} ${d.x},
                          ${d.y} ${d.x}`
                            return path
                        } else {
                            // 可以調整角度
                            path = `M ${s.x} ${s.y}
                         C ${(s.x + s.x) / 2} ${s.y},
                           ${(s.x + d.x) / 2} ${d.y},
                           ${d.x} ${d.y}`

                            return path
                        }
                    }

                    // Toggle children on click.
                    // 在點擊時切換孩子。
                    function click(d) {
                        if (d.children) {
                            d._children = d.children;
                            d.children = null;
                        } else {
                            d.children = d._children;
                            d._children = null;
                        }
                        update(d);
                    }
                }
            }

            toJson.onclick = function () {
                // 預備運算用
                var AA = 0, BB = 0, CC = ''
                var Arr1 = txt1.value.split('\n'), Arr2 = []
                // 刪除所有<ol><li>標記語言的標記
                // txt1.value = txt1.value.replace(/\<\/?ol\>|\<\/?li\>/g, '')
                // 刪除空白字元的行
                for (var k of Arr1) {
                    // 跳過空行，不處理空白符號的行
                    if (/^\s*$/.test(k)) {
                        continue
                    } else {
                        // 先加上{"name符號
                        Arr2.push(k.replace(/^(\s*)(.+)/, '$1{"name":"$2","subname":"","fill":""},'))
                    }
                }
                // 導入Arr1比較好運算
                Arr1 = Arr2

                // 作判斷，加上children。但有些層級還是無法分出
                for (var i = 0; i < Arr1.length; i++) {
                    // 必須判斷Arr1[i + 1]存在
                    if (Arr1[i + 1]) {
                        // 下一行的{比前一行縮排，即加上children
                        if (Arr1[i].indexOf('{') < Arr1[i + 1].indexOf('{')) {
                            Arr1[i] = Arr1[i].replace('},', ',"children":[')
                            // 算出有幾個children
                            AA++
                        }
                        // 下一行的{比前一行凸排，即加上]}
                        if (Arr1[i].indexOf('{') > Arr1[i + 1].indexOf('{')) {
                            Arr1[i] = Arr1[i].replace('},', '},]},')
                            // 算出有幾個凸排
                            BB++
                        }
                    }
                }
                // Arr1.unshift('{[')
                // 補上不足的]}
                if (AA > BB) {
                    for (var i = 0; i < (AA - BB); i++) {
                        CC += ']},\n'
                    }
                }
                // 刪除最後一個,
                CC = CC.substring(0, (CC.length - 2))
                Arr1.push(CC)
                // 結束時呈現結果
                txt1.value = Arr1.join('\n')
                // 結束時選取並複製文本框中的內容
                txt1.select()
                document.execCommand('Copy')
            }

            function Kinds(k1, k2) {
                var k = k1, v = k2
            }

            // 調用D3參數
            d3Example(1, 0, '<span class="g">歷代漢文大藏經概述</span><br/>──李圓淨，原載《南行》第六期（南行學社編印）<br/>點擊節點，開始動畫，按鈕可切換「直書/橫書」「另類樣式」', div1, 10, 10, 10, 30, 1600, 1300, 0, 180, 25, 120)

            // 直書/橫書
            toVertical.onclick = function () {
                // 直書的元素
                var tsvg = document.getElementsByClassName('head')[0]
                if (tsvg) {
                    d3.select('div svg').remove()
                    d3Example(1, 0, '<span class="g">歷代漢文大藏經概述</span><br/>──李圓淨，原載《南行》第六期（南行學社編印）<br/>點擊節點，開始動畫，按鈕可切換「直書/橫書」「另類樣式」', div1, 10, 10, 10, 30, 1600, 1300, 0, 180, 25, 120)
                } else {
                    d3.select('div svg').remove()
                    d3Example(1, 1, '<span class="g">歷代漢文大藏經概述</span><br/>──李圓淨，原載《南行》第六期（南行學社編印）<br/>點擊節點，開始動畫，按鈕可切換「直書/橫書」「另類樣式」', div1, 60, 10, 10, 30, 1400, 1400, 0, 120, 25, 100)
                }
            }

            // 另類樣式
            toKinds.onclick = function () {
                // 直書的元素
                var tsvg = document.getElementsByClassName('head')[0]
                if (tsvg) {
                    d3.select('div svg').remove()
                    d3Example(0, 0, '<span class="g">歷代漢文大藏經概述</span><br/>──李圓淨，原載《南行》第六期（南行學社編印）<br/>點擊<span class="r">紅色</span>節點，開始動畫，按鈕可切換「直書/橫書」「另類樣式」', div1, 10, 10, 10, 30, 1600, 1300, 0, 180, '', '')
                } else {
                    d3.select('div svg').remove()
                    d3Example(0, 1, '<span class="g">歷代漢文大藏經概述</span><br/>──李圓淨，原載《南行》第六期（南行學社編印）<br/>點擊<span class="r">紅色</span>節點，開始動畫，按鈕可切換「直書/橫書」「另類樣式」', div1, 60, 10, 10, 30, 1400, 1400, 0, 100, '', '')
                }
            }

        }
    </script>
</head>

<body>
    <input id="toVertical" type="button" class="o" value="直書/橫書" />
    <input id="toKinds" type="button" class="gy" value="另類樣式" />
    <h2 id="h2"></h2>
    <div id="div1"></div>
    <textarea id='txt1' placeholder='輸入要轉json的原始資料、或原始文章。
用「空白鍵」或「tab鍵」在前面作層級的區分，
轉換完畢後，會自動反白，並自動複製。
以純文字編輯軟體，開啟本網頁檔，
再貼上json，
再以瀏覽器開啟本網頁檔，或「重新整理」即可更新樹狀圖'>漢文大藏經
    國內
        唐(含之前)
            敦煌手抄本
        宋
            蜀版
                開寶藏(西元971-983)
            遼版
                契丹藏(丹本)(約1031-1063)
            金版
                金藏(趙城本)(約1148-1173)
            福州版
                崇寧萬壽藏(福州東禪寺本)(1080-1140)
                毗廬藏(福州開元寺本)(1115-1150)
            湖州版
                思溪圓覺藏(1132-)
                思溪資福藏(1175前後)
            磧砂藏(約1231-1322)
        元
            普寧藏(1269-1286)
            弘法藏(1277-1294)
        明
            南藏(1372-)
            北藏(1410-1441)
            武林藏(約1522-1566)
            徑山藏(嘉興藏本)(1589-1677)
        清
            龍藏(1735-1738)
            頻伽藏(1909-1914)
            百衲藏(1866-)
    國外
        高麗
            高麗大藏初雕本(約1011-1082)
            高麗續藏本(1094前後)
            高麗大藏再雕本(1236-1251)
        日本
            天海藏(寬永寺本)(1637-1648)
            黃蘗藏(鐵眼本)(1669-1681)
            弘教藏(縮刷藏本)(1880-1866)
            卍字藏(1902-1905)
            卍字續藏(1905-0912)
            大正新修大藏經(1922-1932)
            昭和再訂縮刷藏(1935-)
            聖語藏(古寫本與版本集合而成約自759-1093)
            宮本(即福州東禪寺與開元寺本合成之全藏)
</textarea>
    <input id="toJson" type="button" class="tan" value="轉json" />
</body>

</html>